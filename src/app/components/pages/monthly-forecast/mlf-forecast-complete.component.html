
    <div class="p-4">
      <div class="max-w-full mx-auto">
        <!-- Combined Filter Controls -->
        <div class="bg-white rounded-lg border border-gray-200 p-4 mb-4">
          <!-- Main Selection Controls -->
          <div class="flex flex-wrap gap-3 mb-3">
            <!-- Location Selection -->
            <div class="space-y-2 max-w-48">
              <label class="text-sm font-medium text-gray-700">Select Location</label>
              <ui-select
                [options]="locationOptions()"
                [(ngModel)]="selectedLocation"
                placeholder="Choose location..."
                (valueChange)="onLocationChange($event)">
              </ui-select>
            </div>

            <!-- Project Selection with Search -->
            <div class="space-y-2 flex-1 min-w-80">
              <label class="text-sm font-medium text-gray-700">Select Project</label>
              <ui-select
                [options]="projectOptions()"
                [(ngModel)]="selectedProject"
                placeholder="Search and select project..."
                [searchable]="true"
                (valueChange)="onProjectChange($event)">
              </ui-select>
            </div>

            <!-- MLF Filter Selection -->
            <div class="space-y-2 max-w-48 ml-auto">
              <label class="text-sm font-medium text-gray-700">Select MLF Filter</label>
              <ui-select
                [options]="mlfFilterOptions()"
                [(ngModel)]="selectedMLFFilter"
                placeholder="Choose MLF filter..."
                (valueChange)="onMLFFilterChange($event)">
              </ui-select>
            </div>
          </div>

          <!-- Additional Filters - Only show when MLF Filter is selected -->
          <div *ngIf="selectedMLFFilter()">
            <div class="border-t border-gray-200 pt-3">
              <div class="flex flex-wrap gap-3 items-end">
                <!-- Craft Multi-select -->
                <div class="space-y-2 flex-1 min-w-64">
                  <label class="text-sm font-medium text-gray-700">Filter by Craft</label>
                  <ui-popover [isOpen]="openCraftSelect()" (openChange)="onCraftSelectOpenChange($event)">
                    <button 
                      ui-popover-trigger
                      class="w-full justify-between px-3 py-2 text-sm border border-gray-300 rounded-md bg-white hover:bg-gray-50 flex items-center">
                      {{ selectedCrafts().length > 0 
                        ? selectedCrafts().length + ' crafts selected'
                        : 'Select crafts...'
                      }}
                      <lucide-icon [name]="ChevronDownIcon" [size]="16" class="ml-2 opacity-50"></lucide-icon>
                    </button>
                    <div ui-popover-content class="w-80 p-0">
                      <ui-command>
                        <input ui-command-input placeholder="Search crafts..." />
                        <div ui-command-empty>No crafts found.</div>
                        <div ui-command-group>
                          <div ui-command-list>
                            <div ui-command-item (click)="clearAllCrafts()">
                              Clear All
                            </div>
                            <div ui-command-item (click)="selectAllCrafts()">
                              Select All
                            </div>
                            <div 
                              *ngFor="let craft of craftNames"
                              ui-command-item 
                              (click)="toggleCraftSelection(craft)">
                              <div class="flex items-center space-x-2">
                                <div [class]="getCraftCheckboxClasses(craft)">
                                  <lucide-icon 
                                    *ngIf="isCraftSelected(craft)" 
                                    [name]="CheckIcon" 
                                    [size]="12" 
                                    class="text-primary-foreground">
                                  </lucide-icon>
                                </div>
                                <span>{{ craft }}</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </ui-command>
                    </div>
                  </ui-popover>
                </div>

                <!-- Show Negative Variance Only Toggle -->
                <div class="space-y-2">
                  <label class="text-sm font-medium text-gray-700">Show Negative Variance Only</label>
                  <div class="flex items-center space-x-2">
                    <ui-switch
                      [checked]="showNegativeOnly()"
                      (checkedChange)="onNegativeOnlyChange($event)">
                    </ui-switch>
                    <label class="text-sm text-gray-600">
                      Negative variance only
                    </label>
                  </div>
                </div>
              </div>

              <!-- Selected Crafts Display -->
              <div *ngIf="selectedCrafts().length > 0" class="flex items-center gap-2 flex-wrap mt-3">
                <span class="text-sm text-foreground">Selected Crafts:</span>
                <ui-badge 
                  *ngFor="let craft of selectedCrafts(); trackBy: trackByCraftName" 
                  variant="secondary" 
                  [rightIcon]="XIcon"
                  customClasses="gap-1 cursor-pointer"
                  (clicked)="removeCraft(craft)">
                  {{ craft }}
                </ui-badge>
              </div>

              <!-- Active Filters Summary -->
              <div *ngIf="selectedCrafts().length > 0 || showNegativeOnly()" 
                   class="bg-blue-50 rounded-lg p-3 border border-blue-200 mt-3">
                <div class="flex items-center gap-2 text-sm text-blue-800">
                  <span class="font-medium">Active Filters:</span>
                  <ui-badge *ngIf="selectedCrafts().length > 0" variant="outline">
                    {{ selectedCrafts().length }} Crafts Selected
                  </ui-badge>
                  <ui-badge *ngIf="showNegativeOnly()" variant="outline">
                    Negative Variance Only
                  </ui-badge>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Check if all selections are made -->
        <div *ngIf="selectedLocation() && selectedProject() && selectedMLFFilter(); else noSelection">
          <!-- Custom Material Design Tabs -->
          <div class="border-b border-border mb-4">
            <div class="flex space-x-6">
              <button
                *ngFor="let tab of tabs"
                (click)="setActiveTab(tab.id)"
                [class]="getTabClasses(tab.id)">
                {{ tab.name }}
                <div *ngIf="activeTab() === tab.id" 
                     class="absolute bottom-0 left-0 right-0 h-0.5 bg-primary rounded-full">
                </div>
              </button>
            </div>
          </div>
          
          <!-- Tab Content -->
          <div class="space-y-4">
            <div *ngFor="let tab of tabs" class="bg-white rounded-lg border border-gray-200 p-4">
              <div *ngIf="activeTab() === tab.id">
                
                <!-- L4 Craft Report Edit - Complete Implementation -->
                <div *ngIf="tab.id === 'l4-craft-edit'" class="space-y-4">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">L4 (Craft Report Edit)</h3>
                    <div class="flex items-center gap-4">
                      <!-- Date Selection Interface -->
                      <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600">Select dates:</label>
                        <ui-popover 
                          [isOpen]="openDatePicker()" 
                          (openChange)="onDatePickerOpenChange($event)"
                          [contentClass]="'w-80 p-0'">
                          <button 
                            slot="trigger"
                            class="w-48 justify-between px-3 py-2 text-sm border border-gray-300 rounded-md bg-white hover:bg-gray-50 flex items-center">
                            {{ selectedDates().length > 0 
                              ? selectedDates().length + ' dates selected'
                              : 'Select dates...'
                            }}
                            <lucide-icon [name]="CalendarIconRef" [size]="16" class="ml-2 opacity-50"></lucide-icon>
                          </button>
                          
                          <!-- Popover Content -->
                          <ui-command
                            [items]="getDateCommandItems()"
                            [placeholder]="'Search dates...'"
                            [emptyMessage]="'No dates found.'"
                            [showFooter]="false"
                            (itemSelected)="onDateItemSelected($event)">
                          </ui-command>
                        </ui-popover>
                      </div>
                    </div>
                  </div>

                  <!-- Selected Dates Display -->
                  <div *ngIf="selectedDates().length > 0" class="space-y-2 mb-3">
                    <div class="flex items-center gap-2 flex-wrap">
                      <span class="text-sm text-foreground">Selected Dates:</span>
                      <ui-badge 
                        *ngFor="let date of selectedDates(); trackBy: trackByDate" 
                        variant="secondary" 
                        [leftIcon]="CalendarIconRef"
                        [rightIcon]="XIcon"
                        customClasses="gap-1 cursor-pointer"
                        (clicked)="removeSelectedDate(date)">
                        {{ formatDateDisplay(date) }}
                      </ui-badge>
                    </div>

                    <!-- Column Visibility Controls -->
                    <div *ngIf="weeklyDates().length > 0" class="border-t pt-2">
                      <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-foreground">Column Visibility:</span>
                        <div class="flex items-center gap-2">
                          <ui-button variant="outline" size="sm" (clicked)="showAllColumns()">
                            Show All
                          </ui-button>
                          <ui-button variant="outline" size="sm" (clicked)="hideAllColumns()">
                            Hide All
                          </ui-button>
                        </div>
                      </div>
                      <div class="flex items-center gap-2 flex-wrap">
                        <ui-badge 
                          *ngFor="let date of weeklyDates(); let index = index; trackBy: trackByWeeklyDate" 
                          [variant]="isColumnVisible(index) ? 'default' : 'secondary'"
                          [leftIcon]="isColumnVisible(index) ? EyeIcon : EyeOffIcon"
                          [rightIcon]="isColumnVisible(index) ? CheckIcon : XIcon"
                          [customClasses]="getColumnVisibilityClasses(index)"
                          (clicked)="toggleColumnVisibility(index)">
                          {{ date.display }}
                        </ui-badge>
                      </div>
                      <div *ngIf="filteredWeeklyDates().length !== weeklyDates().length" 
                           class="text-xs text-muted-foreground mt-2">
                        Showing {{ filteredWeeklyDates().length }} of {{ weeklyDates().length }} columns
                      </div>
                    </div>
                  </div>
                  

                  
                  <!-- Craft Data Grid - Exact React Layout -->
                  <div *ngIf="filteredCraftData().length > 0; else noCrafts" class="grid gap-4">
                    <div 
                      *ngFor="let craft of filteredCraftData(); let craftIndex = index; trackBy: trackByCraft" 
                      class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                      <!-- Craft Header -->
                      <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                        <h4 class="font-medium text-gray-900">{{ craft.craftName }}</h4>
                      </div>
                      
                      <!-- Week Blocks - Table Layout with Common Headers -->
                      <div class="p-4">
                        <div class="overflow-x-auto mb-3">
                          <div class="min-w-max">
                            <!-- Row Headers Column -->
                            <div class="flex">
                              <div class="flex-shrink-0 w-20">
                                <div class="h-6"></div> <!-- Empty space for date row -->
                                <div class="flex flex-col gap-1">
                                  <div class="h-8 flex items-center justify-center text-xs text-gray-600 font-medium bg-blue-50 border border-blue-200 rounded">
                                    P6 Craft
                                  </div>
                                  <div class="h-8 flex items-center justify-center text-xs text-gray-600 font-medium bg-indigo-50 border border-indigo-200 rounded">
                                    L4 Original
                                  </div>
                                  <div class="h-8 flex items-center justify-center text-xs text-gray-600 font-medium bg-gray-50 border border-gray-200 rounded">
                                    L4 Updated
                                  </div>
                                  <div class="h-8 flex items-center justify-center text-xs text-gray-600 font-medium bg-purple-50 border border-purple-200 rounded">
                                    L4 Variance
                                  </div>
                                  <div class="h-8 flex items-center justify-center text-xs text-gray-600 font-medium bg-orange-50 border border-orange-200 rounded">
                                    P6 vs L4
                                  </div>
                                </div>
                              </div>
                              
                              <!-- Week Columns -->
                              <div class="flex gap-2 ml-2">
                                <div 
                                  *ngFor="let date of filteredWeeklyDates(); let displayIndex = index; trackBy: trackByFilteredDate" 
                                  class="flex-shrink-0 w-24">
                                  <!-- Date Header - Clickable for selection -->
                                  <button
                                    (click)="toggleGridColumnSelection(getCraftKey(craftIndex), getOriginalIndex(date))"
                                    [class]="getDateHeaderClasses(craftIndex, date)">
                                    <div class="flex items-center gap-1">
                                      {{ date.display }}
                                      <lucide-icon 
                                        *ngIf="isGridColumnSelected(getCraftKey(craftIndex), getOriginalIndex(date))" 
                                        [name]="CheckIcon" 
                                        [size]="12">
                                      </lucide-icon>
                                    </div>
                                  </button>
                                  
                                  <!-- Value Column -->
                                  <div class="flex flex-col gap-1">
                                    <!-- P6 Craft Value -->
                                    <button
                                      (click)="toggleBlockExpansion(craftIndex, getOriginalIndex(date))"
                                      [class]="getP6CraftButtonClasses(craftIndex, getOriginalIndex(date))">
                                      <div class="text-xs text-gray-900 font-medium">
                                        {{ getP6CraftValue(craft, displayIndex) }}
                                      </div>
                                    </button>
                                    
                                    <!-- L4 Original Value -->
                                    <button
                                      (click)="toggleBlockExpansion(craftIndex, getOriginalIndex(date))"
                                      [class]="getL4OriginalButtonClasses(craftIndex, getOriginalIndex(date))">
                                      <div class="text-xs text-gray-900 font-medium">
                                        {{ calculateOriginalTotalActivityHours(getOriginalIndex(date)) }}
                                      </div>
                                    </button>
                                    
                                    <!-- L4 Updated Value -->
                                    <button
                                      (click)="toggleBlockExpansion(craftIndex, getOriginalIndex(date))"
                                      [class]="getL4UpdatedButtonClasses(craftIndex, getOriginalIndex(date))">
                                      <div [class]="getL4UpdatedTextClasses(getOriginalIndex(date))">
                                        {{ calculateTotalActivityHours(getOriginalIndex(date)) }}
                                      </div>
                                    </button>
                                    
                                    <!-- L4 Variance (L4 Original - L4 Updated) -->
                                    <div [class]="getL4VarianceClasses(getOriginalIndex(date))">
                                      <div [class]="getL4VarianceTextClasses(getOriginalIndex(date))">
                                        {{ formatVariance(getL4Variance(getOriginalIndex(date))) }}
                                      </div>
                                    </div>
                                    
                                    <!-- P6 vs L4 Variance (P6 Craft - L4 Updated) -->
                                    <div [class]="getP6VsL4VarianceClasses(craft, displayIndex, getOriginalIndex(date))">
                                      <div [class]="getP6VsL4VarianceTextClasses(craft, displayIndex, getOriginalIndex(date))">
                                        {{ formatVariance(getP6VsL4Variance(craft, displayIndex, getOriginalIndex(date))) }}
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Individual Craft Sections - Show when this craft has grid columns selected -->
                        <div *ngIf="hasSelectedGridColumns(getCraftKey(craftIndex))" class="mt-4 border-t border-gray-200 pt-4">
                          <div class="mb-3">
                            <div class="flex items-center justify-between mb-3">
                              <h5 class="font-medium text-gray-900">
                                Details for {{ craft.craftName }} - Selected Dates
                              </h5>
                              
                              <!-- Activity Filter and Action Buttons -->
                              <div class="flex items-center gap-2">
                                <lucide-icon [name]="FilterIcon" [size]="16" class="text-gray-500"></lucide-icon>
                                <div class="relative activity-dropdown">
                                  <button 
                                    (click)="toggleActivityDropdown(getCraftKey(craftIndex))"
                                    class="h-8 px-3 py-1 text-sm border border-gray-300 rounded-md bg-white hover:bg-gray-50 flex items-center">
                                    {{ getSelectedActivitiesText(getCraftKey(craftIndex)) }}
                                    <lucide-icon [name]="ChevronDownIcon" [size]="14" class="ml-1"></lucide-icon>
                                  </button>
                                  
                                  <!-- Dropdown Menu -->
                                  <div *ngIf="getActivitySelectOpen(getCraftKey(craftIndex))" 
                                       class="absolute top-full left-0 mt-1 w-64 bg-white border border-gray-200 rounded-md shadow-lg z-50">
                                    <!-- Search Input -->
                                    <div class="p-2 border-b border-gray-200">
                                      <input 
                                        type="text"
                                        placeholder="Search activities..."
                                        [(ngModel)]="activitySearchTerm"
                                        (click)="$event.stopPropagation()"
                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    </div>
                                    
                                    <!-- Activity List -->
                                    <div class="max-h-48 overflow-y-auto">
                                      <!-- Clear All Option -->
                                      <div 
                                        (click)="clearActivityFilter(getCraftKey(craftIndex)); closeActivityDropdown(getCraftKey(craftIndex))"
                                        class="px-3 py-2 text-sm hover:bg-gray-100 cursor-pointer border-b border-gray-100">
                                        Clear All
                                      </div>
                                      
                                      <!-- Activity Options -->
                                      <div 
                                        *ngFor="let activity of getFilteredAvailableActivities()"
                                        (click)="toggleActivitySelection(getCraftKey(craftIndex), activity)"
                                        class="px-3 py-2 text-sm hover:bg-gray-100 cursor-pointer">
                                        <div class="flex items-center space-x-2">
                                          <!-- Checkbox -->
                                          <div [class]="getActivityCheckboxClasses(getCraftKey(craftIndex), activity)">
                                            <lucide-icon 
                                              *ngIf="isActivitySelected(getCraftKey(craftIndex), activity)" 
                                              [name]="CheckIcon" 
                                              [size]="12" 
                                              class="text-white">
                                            </lucide-icon>
                                          </div>
                                          <!-- Activity Info -->
                                          <div>
                                            <div class="font-medium">{{ activity }}</div>
                                            <div class="text-xs text-gray-500">{{ getActivityDescription(activity) }}</div>
                                          </div>
                                        </div>
                                      </div>
                                      
                                      <!-- No Results -->
                                      <div *ngIf="getFilteredAvailableActivities().length === 0" 
                                           class="px-3 py-2 text-sm text-gray-500">
                                        No activities found.
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="flex items-center gap-2 ml-4">
                                  <ui-button 
                                    variant="outline" 
                                    size="sm"
                                    [leftIcon]="TrendingUpIcon"
                                    (clicked)="recalculateAllTotals()">
                                    Recalculate All
                                  </ui-button>
                                  <ui-button 
                                    [variant]="hasUnsavedChanges() ? 'primary' : 'outline'"
                                    size="sm"
                                    [leftIcon]="SaveIcon"
                                    (clicked)="saveAllChanges()"
                                    [class]="getSaveButtonClasses()">
                                    Save
                                    <span *ngIf="hasUnsavedChanges()" class="ml-1 bg-white/20 text-xs px-1 rounded">
                                      •
                                    </span>
                                  </ui-button>
                                  <ui-button 
                                    variant="outline" 
                                    size="sm"
                                    [leftIcon]="RotateCcwIcon"
                                    (clicked)="resetAllData()">
                                    Reset
                                  </ui-button>
                                  <ui-button 
                                    variant="outline" 
                                    size="sm"
                                    [leftIcon]="RefreshCwIcon"
                                    (clicked)="refreshAllData()">
                                    Refresh
                                  </ui-button>
                                </div>
                              </div>
                            </div>

                            <!-- Selected Activities Display -->
                            <div *ngIf="getSelectedActivities(getCraftKey(craftIndex)).length > 0" 
                                 class="flex items-center gap-2 flex-wrap mb-3">
                              <span class="text-sm text-foreground">Filtered Activities:</span>
                              <ui-badge 
                                *ngFor="let activity of getSelectedActivities(getCraftKey(craftIndex)); trackBy: trackByActivity" 
                                variant="secondary" 
                                [rightIcon]="XIcon"
                                customClasses="gap-1 cursor-pointer"
                                (clicked)="removeActivitySelection(getCraftKey(craftIndex), activity)">
                                {{ activity }}
                              </ui-badge>
                            </div>
                          </div>
                          
                          <div class="space-y-4">
                            <!-- Section 1: Forecast Plan Hours -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                              <div class="mb-3">
                                <h6 class="font-medium text-blue-900">
                                  1. Forecast Plan Hours (Read Only)
                                </h6>
                                <p class="text-xs text-blue-700 mt-1">Activity data with weekly hours multiplied by 60</p>
                              </div>
                              <div class="overflow-x-auto">
                                <table class="w-full border-collapse border border-gray-200 rounded-lg">
                                  <thead class="bg-gray-50">
                                    <tr>
                                      <th class="min-w-20 px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Activity ID</th>
                                      <th class="min-w-32 px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Activity Description</th>
                                      <th 
                                        *ngFor="let dateObj of getFilteredDatesForCraft(getCraftKey(craftIndex)); trackBy: trackByDateDisplay" 
                                        class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">
                                        {{ dateObj.display }}
                                      </th>
                                    </tr>
                                  </thead>
                                  <tbody class="bg-white divide-y divide-gray-200">
                                    <tr 
                                      *ngFor="let activity of getFilteredActivitySpread(getCraftKey(craftIndex)); let rowIndex = index; trackBy: trackByActivityCode"
                                      class="hover:bg-gray-50">
                                      <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">{{ activity.activityCode }}</td>
                                      <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{{ activity.description }}</td>
                                      <td 
                                        *ngFor="let dateObj of getFilteredDatesForCraft(getCraftKey(craftIndex)); let displayIndex = index; trackBy: trackByDateDisplay" 
                                        class="px-3 py-2 whitespace-nowrap text-center">
                                        <div class="w-16 mx-auto">
                                          <div [class]="getForecastHoursCellClasses(activity, displayIndex, getFilteredDatesForCraft(getCraftKey(craftIndex)))">
                                            {{ getForecastHoursValue(activity, displayIndex, getFilteredDatesForCraft(getCraftKey(craftIndex))) }}
                                          </div>
                                        </div>
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                              </div>
                            </div>

                            <!-- Section 2: Level 4 Craft (Calculated) -->
                            <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                              <div class="flex items-center justify-between mb-3">
                                <h6 class="font-medium text-green-900">
                                  2. Level 4 Craft (Calculated - Read Only)
                                </h6>
                                <div class="text-xs text-green-700">
                                  Auto-calculated distributed workforce (Forecasted Hours ÷ 60)
                                </div>
                              </div>
                              <div class="overflow-x-auto">
                                <table class="w-full border-collapse border border-gray-200 rounded-lg">
                                  <thead class="bg-gray-50">
                                    <tr>
                                      <th class="min-w-20 px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Link Code</th>
                                      <th class="min-w-32 px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Link Code Description</th>
                                      <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">AFC Hr</th>
                                      <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">WP Hrs</th>
                                      <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">To Go Hrs</th>
                                      <th class="min-w-24 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Fcst Start</th>
                                      <th class="min-w-24 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Fcst Finish</th>
                                      <th 
                                        *ngFor="let dateObj of getFilteredDatesForCraft(getCraftKey(craftIndex)); trackBy: trackByDateDisplay" 
                                        class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">
                                        {{ dateObj.display }}
                                      </th>
                                    </tr>
                                  </thead>
                                  <tbody class="bg-white divide-y divide-gray-200">
                                    <tr 
                                      *ngFor="let l4 of getFilteredL4Activities(getCraftKey(craftIndex)); let rowIndex = index; trackBy: trackByL4JobNumber"
                                      class="hover:bg-gray-50">
                                      <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-blue-700">{{ l4.jobNumber }}</td>
                                      <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{{ l4.activityCode }} - Link Description</td>
                                      <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-900">{{ getAfcHours(l4) }}</td>
                                      <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-900">{{ getWpHours(l4) }}</td>
                                      <td class="px-3 py-2 whitespace-nowrap text-sm text-center font-medium text-gray-900">{{ getToGoHours(l4) }}</td>
                                      <td class="px-3 py-2 whitespace-nowrap text-xs text-center text-gray-900">{{ l4.start }}</td>
                                      <td class="px-3 py-2 whitespace-nowrap text-xs text-center text-gray-900">{{ l4.end }}</td>
                                      <td 
                                        *ngFor="let dateObj of getFilteredDatesForCraft(getCraftKey(craftIndex)); let displayIndex = index; trackBy: trackByDateDisplay" 
                                        class="px-3 py-2 whitespace-nowrap text-center">
                                        <div class="w-16 mx-auto">
                                          <div [class]="getWorkforceCellClasses(l4, displayIndex, getFilteredDatesForCraft(getCraftKey(craftIndex)))">
                                            {{ getWorkforceValue(l4, displayIndex, getFilteredDatesForCraft(getCraftKey(craftIndex))) }}
                                          </div>
                                        </div>
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                              </div>
                            </div>

                            <!-- Section 3: Level 4 Forecasted Hours (Calculated) - EDITABLE DATES -->
                            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                              <div class="flex items-center justify-between mb-3">
                                <h6 class="font-medium text-indigo-900">
                                  3. Level 4 Forecasted Hours (Calculated - Editable Dates)
                                </h6>
                                <div class="text-xs text-indigo-700">
                                  Edit dates to auto-calculate distributed hours. Hours = To Go Hrs ÷ Working Days × Days in Week
                                </div>
                              </div>

                              <div class="overflow-x-auto">
                                <table class="w-full border-collapse border border-gray-200 rounded-lg">
                                  <thead class="bg-gray-50">
                                    <tr>
                                      <th class="min-w-20 px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Link Code</th>
                                      <th class="min-w-32 px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Link Code Description</th>
                                      <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">AFC Hr</th>
                                      <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">WP Hrs</th>
                                      <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">To Go Hrs</th>
                                      <th class="min-w-24 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Fcst Start</th>
                                      <th class="min-w-24 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Fcst Finish</th>
                                      <th 
                                        *ngFor="let dateObj of getFilteredDatesForCraft(getCraftKey(craftIndex)); trackBy: trackByDateDisplay" 
                                        class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">
                                        {{ dateObj.display }}
                                      </th>
                                    </tr>
                                  </thead>
                                  <tbody class="bg-white divide-y divide-gray-200">
                                    <tr 
                                      *ngFor="let l4 of getFilteredL4Activities(getCraftKey(craftIndex)); let rowIndex = index; trackBy: trackByL4JobNumber"
                                      class="hover:bg-gray-50">
                                      <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-blue-700">{{ l4.jobNumber }}</td>
                                      <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{{ l4.activityCode }} - Link Description</td>
                                      <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-900">{{ getAfcHours(l4) }}</td>
                                      <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-900">{{ getWpHours(l4) }}</td>
                                      <td class="px-3 py-2 whitespace-nowrap text-sm text-center font-medium text-gray-900">{{ getToGoHours(l4) }}</td>
                                      <td class="px-3 py-2 whitespace-nowrap text-center">
                                        <button 
                                          class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-blue-50 border-2 border-blue-300 rounded-md hover:bg-blue-100 hover:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                                          (click)="openL4DatePickerFor(rowIndex, 'start')">
                                          <lucide-icon [name]="CalendarIconRef" [size]="14" class="mr-2 text-blue-600"></lucide-icon>
                                          <span class="text-gray-800 font-semibold"> {{ l4.start }}</span>
                                        </button>
                                        
                                        <!-- Popover for date picker -->
                                        <ui-popover 
                                          [isOpen]="isL4DatePickerOpen(rowIndex, 'start')" 
                                          (openChange)="!$event && closeL4DatePicker()"
                                          [contentClass]="'p-0'">
                                          <div ui-popover-content>
                                            <ui-calendar
                                              [mode]="'single'"
                                              (dateSelected)="onL4DateSelected(rowIndex, 'start', $event)">
                                            </ui-calendar>
                                          </div>
                                        </ui-popover>
                                      </td>
                                      <td class="px-3 py-2 whitespace-nowrap text-center">
                                        <button 
                                          class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-green-50 border-2 border-green-300 rounded-md hover:bg-green-100 hover:border-green-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors duration-200"
                                          (click)="openL4DatePickerFor(rowIndex, 'end')">
                                          <lucide-icon [name]="CalendarIconRef" [size]="14" class="mr-2 text-green-600"></lucide-icon>
                                          <span class="text-gray-800 font-semibold"> {{ l4.end }}</span>
                                        </button>
                                        
                                        <!-- Popover for date picker -->
                                        <ui-popover 
                                          [isOpen]="isL4DatePickerOpen(rowIndex, 'end')" 
                                          (openChange)="!$event && closeL4DatePicker()"
                                          [contentClass]="'p-0'">
                                          <div ui-popover-content>
                                            <ui-calendar
                                              [mode]="'single'"
                                              (dateSelected)="onL4DateSelected(rowIndex, 'end', $event)">
                                            </ui-calendar>
                                          </div>
                                        </ui-popover>
                                      </td>
                                      <td 
                                        *ngFor="let dateObj of getFilteredDatesForCraft(getCraftKey(craftIndex)); let displayIndex = index; trackBy: trackByDateDisplay" 
                                        class="px-3 py-2 whitespace-nowrap text-center">
                                        <div class="w-16 mx-auto">
                                          <div [class]="getDistributedHoursCellClasses(l4, displayIndex, getFilteredDatesForCraft(getCraftKey(craftIndex)))">
                                            {{ getDistributedHoursValue(l4, displayIndex, getFilteredDatesForCraft(getCraftKey(craftIndex))) }}
                                          </div>
                                        </div>
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                              </div>
                            </div>
                          </div>

                          <!-- Section 4: SPC Detailed Work Pack With Calculated Distributed Hours (Read Only) -->
                          <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-3">
                              <h6 class="font-medium text-purple-900">
                                4. SPC Detailed Work Pack With Calculated Distributed Hours (Read Only)
                              </h6>
                              <div class="text-xs text-purple-700">
                                Work pack details with distributed hours. Auto-calculated from SPC workforce data.
                              </div>
                            </div>
                            <div class="overflow-x-auto">
                              <table class="w-full border-collapse border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50">
                                  <tr>
                                    <th class="min-w-20 px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">WP No</th>
                                    <th class="min-w-32 px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">WP Description</th>
                                    <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">AFC Hrs</th>
                                    <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">WP Hrs</th>
                                    <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">AFC Earned</th>
                                    <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">WP Earned</th>
                                    <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Togo Hrs</th>
                                    <th class="min-w-24 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Sch Fcst Start</th>
                                    <th class="min-w-24 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Sch Fcst Finish</th>
                                    <th 
                                      *ngFor="let dateObj of getFilteredDatesForCraft(getCraftKey(craftIndex)); trackBy: trackByDateDisplay" 
                                      class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">
                                      {{ dateObj.display }}
                                    </th>
                                  </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                  <tr 
                                    *ngFor="let spc of getFilteredSPCActivities(getCraftKey(craftIndex)); let rowIndex = index; trackBy: trackBySPCSubCode"
                                    class="hover:bg-gray-50">
                                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-purple-700">{{ spc.subCode }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{{ spc.activityCode }} - {{ getSPCDescription(spc) }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-900">{{ getSPCAFCHours(spc) }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-900">{{ getSPCWPHours(spc) }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-900">{{ getSPCAFCEarned(spc) }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-900">{{ getSPCWPEarned(spc) }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-900">{{ getSPCTogoHours(spc) }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-xs text-center text-gray-900">{{ spc.start }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-xs text-center text-gray-900">{{ spc.end }}</td>
                                    <td 
                                      *ngFor="let dateObj of getFilteredDatesForCraft(getCraftKey(craftIndex)); let displayIndex = index; trackBy: trackByDateDisplay" 
                                      class="px-3 py-2 whitespace-nowrap text-center">
                                      <div class="w-16 mx-auto">
                                        <div [class]="getSPCDistributedHoursCellClasses(spc, displayIndex, getFilteredDatesForCraft(getCraftKey(craftIndex)))">
                                          {{ getSPCDistributedHoursValue(spc, displayIndex, getFilteredDatesForCraft(getCraftKey(craftIndex))) }}
                                        </div>
                                      </div>
                                    </td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>
                          </div>

                          <!-- Section 5: SPC Detailed Work Pack With Calculated Distributed Workforce - EDITABLE DATES -->
                          <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-3">
                              <h6 class="font-medium text-orange-900">
                                5. SPC Detailed Work Pack With Calculated Distributed Workforce (Editable Dates)
                              </h6>
                              <div class="text-xs text-orange-700">
                                Edit dates to auto-calculate distributed workforce. SPC data rolls up to L4 Hours. Freeze logic preserves past values.
                              </div>
                            </div>
                            <div class="overflow-x-auto">
                              <table class="w-full border-collapse border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50">
                                  <tr>
                                    <th class="min-w-20 px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">WP No</th>
                                    <th class="min-w-32 px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">WP Description</th>
                                    <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">AFC Hrs</th>
                                    <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">WP Hrs</th>
                                    <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">AFC Earned</th>
                                    <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">WP Earned</th>
                                    <th class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Togo Hrs</th>
                                    <th class="min-w-24 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Sch Fcst Start</th>
                                    <th class="min-w-24 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Sch Fcst Finish</th>
                                    <th 
                                      *ngFor="let dateObj of getFilteredDatesForCraft(getCraftKey(craftIndex)); trackBy: trackByDateDisplay" 
                                      class="min-w-16 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">
                                      {{ dateObj.display }}
                                    </th>
                                  </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                  <tr 
                                    *ngFor="let spc of getFilteredSPCActivities(getCraftKey(craftIndex)); let rowIndex = index; trackBy: trackBySPCSubCode"
                                    class="hover:bg-gray-50">
                                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-purple-700">{{ spc.subCode }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{{ spc.activityCode }} - {{ getSPCDescription(spc) }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-900">{{ getSPCAFCHours(spc) }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-900">{{ getSPCWPHours(spc) }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-900">{{ getSPCAFCEarned(spc) }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-900">{{ getSPCWPEarned(spc) }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center text-gray-900">{{ getSPCTogoHours(spc) }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-center">
                                      <button 
                                        class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-purple-50 border-2 border-purple-300 rounded-md hover:bg-purple-100 hover:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-200"
                                        (click)="openSPCDatePickerFor(rowIndex, 'start')">
                                        <lucide-icon [name]="CalendarIconRef" [size]="14" class="mr-2 text-purple-600"></lucide-icon>
                                        <span class="text-gray-800 font-semibold">{{ spc.start }}</span>
                                      </button>
                                      
                                      <!-- Popover for date picker -->
                                      <ui-popover 
                                        [isOpen]="isSPCDatePickerOpen(rowIndex, 'start')" 
                                        (openChange)="!$event && closeSPCDatePicker()"
                                        [contentClass]="'p-0'">
                                        <div ui-popover-content>
                                          <ui-calendar
                                            [mode]="'single'"
                                            (dateSelected)="onSPCDateSelected(rowIndex, 'start', $event)">
                                          </ui-calendar>
                                        </div>
                                      </ui-popover>
                                    </td>
                                    <td class="px-3 py-2 whitespace-nowrap text-center">
                                      <button 
                                        class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-orange-50 border-2 border-orange-300 rounded-md hover:bg-orange-100 hover:border-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors duration-200"
                                        (click)="openSPCDatePickerFor(rowIndex, 'end')">
                                        <lucide-icon [name]="CalendarIconRef" [size]="14" class="mr-2 text-orange-600"></lucide-icon>
                                        <span class="text-gray-800 font-semibold">{{ spc.end }}</span>
                                      </button>
                                      
                                      <!-- Popover for date picker -->
                                      <ui-popover 
                                        [isOpen]="isSPCDatePickerOpen(rowIndex, 'end')" 
                                        (openChange)="!$event && closeSPCDatePicker()"
                                        [contentClass]="'p-0'">
                                        <div ui-popover-content>
                                          <ui-calendar
                                            [mode]="'single'"
                                            (dateSelected)="onSPCDateSelected(rowIndex, 'end', $event)">
                                          </ui-calendar>
                                        </div>
                                      </ui-popover>
                                    </td>
                                    <td 
                                      *ngFor="let dateObj of getFilteredDatesForCraft(getCraftKey(craftIndex)); let displayIndex = index; trackBy: trackByDateDisplay" 
                                      class="px-3 py-2 whitespace-nowrap text-center">
                                      <div class="w-16 mx-auto">
                                        <div [class]="getSPCWorkforceCellClasses(spc, displayIndex, getFilteredDatesForCraft(getCraftKey(craftIndex)))">
                                          {{ getSPCWorkforceValue(spc, displayIndex, getFilteredDatesForCraft(getCraftKey(craftIndex))) }}
                                        </div>
                                      </div>
                                    </td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <ng-template #noCrafts>
                    <div class="bg-gray-50 rounded-lg p-6 text-center">
                      <p class="text-gray-500">
                        No crafts match the current filter criteria. Try adjusting your filters.
                      </p>
                    </div>
                  </ng-template>
                </div>

                <!-- P6 Craft Report Table -->
                <div *ngIf="tab.id === 'original-craft-report'" class="space-y-3">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">P6 Craft Report</h3>
                    <div class="text-sm text-gray-500">
                      {{ filteredCraftData().length > 0 ? 
                        'Showing ' + filteredCraftData().length + ' craft' + (filteredCraftData().length === 1 ? '' : 's') :
                        'No crafts match current filters'
                      }}
                    </div>
                  </div>
                  
                  <div *ngIf="filteredCraftData().length > 0; else noCraftsP6" class="overflow-x-auto">
                    <table class="min-w-max w-full border-collapse">
                      <thead>
                        <tr class="bg-gray-50 border-b border-gray-200">
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-48 sticky left-0 bg-gray-50 z-10 border-r border-gray-200">
                            Craft Name
                          </th>
                          <th 
                            *ngFor="let date of filteredWeeklyDates(); let i = index" 
                            class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider min-w-24 border-r border-gray-200">
                            {{ date.display }}
                          </th>
                        </tr>
                      </thead>
                      <tbody class="bg-white divide-y divide-gray-200">
                        <tr 
                          *ngFor="let craft of filteredCraftData(); let craftIndex = index" 
                          class="hover:bg-gray-50">
                          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white z-10 border-r border-gray-200">
                            {{ craft.craftName }}
                          </td>
                          <td 
                            *ngFor="let date of filteredWeeklyDates(); let weekIndex = index" 
                            class="px-4 py-4 text-center text-sm text-gray-900 border-r border-gray-200">
                            {{ getFilteredCraftValue(craft, weekIndex) !== 0 ? getFilteredCraftValue(craft, weekIndex) : '-' }}
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <ng-template #noCraftsP6>
                    <div class="bg-gray-50 rounded-lg p-6 text-center">
                      <p class="text-gray-500">
                        No crafts match the current filter criteria. Try adjusting your filters.
                      </p>
                    </div>
                  </ng-template>
                </div>

              </div>
            </div>
          </div>
        </div>

        <ng-template #noSelection>
          <div class="bg-gray-50 rounded-lg p-6 text-center">
            <p class="text-gray-500">
              Please select all required filters (Location, Project, and MLF Filter) to view the forecast data.
            </p>
          </div>
        </ng-template>
      </div>
    </div>
  